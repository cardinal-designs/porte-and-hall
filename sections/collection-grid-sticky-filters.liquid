{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-product-grid.css' | asset_url | stylesheet_tag }}
{{ 'component-collection-filters.css' | asset_url | stylesheet_tag }}
{{ 'component-sticky-collection-filters.css' | asset_url | stylesheet_tag }}

<style>
  @media screen and (max-width: 768px) {

  #ProductGridContainer {
    margin: 0 0 24px;
  }

}
</style>

<script src="{{ 'collection-filters.js' | asset_url }}" defer="defer"></script>

{% assign active_tags = '' %}
{% for tag in current_tags %}
  {% assign tag_as_handle = tag | replace: '&#39;', '' | replace: '&#34;', '' | handle %}
  {% assign active_tags = active_tags | append: tag_as_handle %}
  {% unless forloop.last %}{% assign active_tags = active_tags | append: '+' %}{% endunless %}
{% endfor %}

<link rel="preload" href="{{ 'component-rte.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">

<div class="page-width">
  <div class="collection-grid__inner">

    <div id="sticky-wrap-{{ section.id }}" class="sticky-filters-wrap" data-section-id="{{ section.id }}">
      <div id="sticky-bar-{{ section.id }}" class="sticky-filters-bar" role="region" aria-label="Collection filters">
        {% if section.blocks.size > 0 %}
          <div class="head-slide-wrap title-carousel" id="head-slide-wrap">
            <ul class="head-slide">
              {%- capture contentForQuerystring -%}{{ content_for_header }}{%- endcapture -%}
                {%- assign pageUrl = contentForQuerystring
                  | split: '"pageurl":"'
                  | last
                  | split: '"'
                  | first
                  | split: '.myshopify.com'
                  | last
                  | replace: '\/', '/'
                  | replace: '%20', ' '
                  | replace: '\u0026', '&'
              -%}
              {% capture finalurl %}https://{{ pageUrl }}{% endcapture %}

              {%- assign key_and_value = pageUrl | split:'?' -%}

              {% for block in section.blocks %}
                <li {% if block.settings.link contains key_and_value[1] %} class="active" {% endif %}><a href="{{ block.settings.link }}">{{ block.settings.title }}</a></li> 
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="sticky-filters-bar__inner">
          {% render 'collection-filters' %}
        </div>
      </div>
      <div id="sticky-placeholder-{{ section.id }}" class="sticky-filters-placeholder" aria-hidden="true"></div>
    </div>

    <div id="ProductGridContainer">
      {% if collection.products.size == 0 %}
        <div class="collection collection--empty" id="product-grid" data-id="{{ section.id }}">
          <div class="loading-overlay gradient"></div>
          <div class="title-wrapper center">
            <h2 class="title title--primary">
              {{ 'sections.collection_template.empty' | t -}}
              <br>
              {{ 'sections.collection_template.use_fewer_filters_html' | t }}
              <button onclick="clearAll(event)" class="h2 collection-filter-clear-all">clear all</button>.
            </h2>
          </div>
        </div>
      {% else %}
        <div class="collection">
          {% paginate collection.products by 50 %}
            <ul id="product-grid" data-id="{{ section.id }}" class="product-grid product-grid-4 list-unstyled">
              {% for product in collection.products %}
                {% for collection in product.collections %}
                  {% if collection.title contains ' |' %}
                    {% assign grouped_collection = collection %}
                  {% endif %}
                {% endfor %}
                <li class="product-grid__item">
                  {% render 'grouped-product-card-4',
                    product_card_product: product,
                    collection: grouped_collection,
                    title: grouped_collection.title,
                    button_text: 'Shop Now',
                    forloop_index: forloop.index
                  %}
                </li>
              {% endfor %}
            </ul>

            <div id="load-more-wrapper" class="load-more-wrapper">
              {% if paginate.pages > 1 and paginate.next %}
                <load-more role="button" class="button" data-load-more="{{ paginate.next.url }}">
                  <span>Load more</span>
                  <div class="loading-overlay__spinner">
                    <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </load-more>
              {% endif %}
            </div>
          {% endpaginate %}
        </div>
      {% endif %}
    </div>

    <div class="loading-overlay">
      <div class="loading-overlay__spinner">
        <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
          <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
        </svg>
      </div>
    </div>

  </div>
</div>


  <script>
    (function(){
      var w=document.getElementById('sticky-wrap-{{ section.id }}');
      var b=document.getElementById('sticky-bar-{{ section.id }}');
      var p=document.getElementById('sticky-placeholder-{{ section.id }}');
      if(!w||!b||!p) return;

      function H(){
        var h=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var a=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var n=document.querySelector('.header__navigation'); var nh=0;
        if(n){var cs=getComputedStyle(n); if(cs.display!=='none'&&/(fixed|sticky)/.test(cs.position)&&window.matchMedia('(min-width: 990px)').matches) nh=n.offsetHeight;}
        return (h?h.offsetHeight:0)+(a&&getComputedStyle(a).display!=='none'?a.offsetHeight:0)+nh+88;
      }

      var end=document.getElementById('sticky-end-sentinel-{{ section.id }}');
      if(!end){ end=document.createElement('div'); end.id='sticky-end-sentinel-{{ section.id }}'; end.style.height='1px'; (document.getElementById('ProductGridContainer')||w.parentElement).parentNode.insertBefore(end,(document.getElementById('ProductGridContainer')||w.parentElement).nextSibling); }

      var sY=0, eY=0, off=0, L=0, W=0, stop=0;

      function footTop(){
        var f=document.querySelector('#shopify-section-footer, .footer, .site-footer, footer');
        if(!f) return 1/0;
        var r=f.getBoundingClientRect();
        return r.top+(window.pageYOffset||document.documentElement.scrollTop);
      }

      function measure(){
        b.style.position='static'; b.style.left=''; b.style.width=''; b.style.top=''; b.style.transform=''; b.classList.remove('is-fixed','is-docked');
        if(document.querySelector('.collection-filters__button')){
          p.style.height=document.querySelector('.collection-filters__button').offsetHeight+'px';
        }
        off=H();
        // console.log('offset height:', off);
        var st=window.pageYOffset||document.documentElement.scrollTop;
        sY=w.getBoundingClientRect().top+st;
        eY=end.getBoundingClientRect().top+st;
        stop=Math.min(eY,footTop())-1;

        console.log('sY::: ',sY);
        console.log('off::: ',off);
        var r=b.getBoundingClientRect(); L=r.left+window.pageXOffset; W=r.width;
        b.dataset.fixedLeft=L; b.dataset.fixedWidth=W;
      }

      function apply(){
        var y=window.pageYOffset||document.documentElement.scrollTop, h=b.offsetHeight;

        console.log('y+off:: ',y+off);
        if(y+off<=sY){ if(b.classList.contains('is-fixed')||b.classList.contains('is-docked')){ b.style.position='static'; b.style.left=''; b.style.width=''; b.style.top=''; b.style.transform=''; b.classList.remove('is-fixed','is-docked'); } return; }
        if(y+off+h>=stop){
          var wt=w.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop);
          b.style.position='absolute'; b.style.zIndex='5'; b.style.top=((stop-h)-wt)+'px'; b.style.left='0'; b.style.width='100%'; b.style.transform=''; b.classList.remove('is-fixed'); b.classList.add('is-docked'); return;
        }
        var wv=parseFloat(b.dataset.fixedWidth)||b.getBoundingClientRect().width;
        var lv=parseFloat(b.dataset.fixedLeft)||(b.getBoundingClientRect().left+window.pageXOffset);
        b.style.position='fixed'; b.style.zIndex='9'; b.style.top=off+'px'; b.style.left=lv+'px'; b.style.width=wv+'px'; b.classList.add('is-fixed'); b.classList.remove('is-docked');
        {% comment %} if(window.innerWidth < 769){
          b.style.position='fixed'; b.style.zIndex='9'; b.style.top=(parseFloat(off) - 88) + 'px'; b.style.background='var(--color-background, #fff)';b.style.left=lv+'px'; b.style.width='100%'; b.classList.add('is-fixed'); b.classList.remove('is-docked');
        } {% endcomment %}
      }

      function recalc(){ measure(); apply(); }
      window.addEventListener('load',recalc,{passive:true});
      window.addEventListener('resize',recalc,{passive:true});
      window.addEventListener('orientationchange',recalc,{passive:true});
      window.addEventListener('scroll',function(){ var nh=H(); if(Math.abs(nh-off)>2) measure(); apply(); },{passive:true});
      measure(); apply();

      window.clearAll=function(e){ e&&e.preventDefault(); document.querySelector('collection-filters')?.clearAllFilters?.(); };
    })();
    </script>

    <script>
    (function(){
      var mq=window.matchMedia('(max-width: 989px)');
      var HDR=200, DRZ=190, BTN=120, SEC=110;
      var sec=document.querySelector('.head-slide-wrap--main');
      if(!sec) return;
      var btn=sec.querySelector('.collection-filters__button.hide-desktop');
      var drawer=sec.querySelector('collection-filters');
      if(!btn||!drawer) return;

      var ph1=document.createElement('div');
      var ph2=document.createElement('div');
      ph1.style.height='0px';
      ph2.style.height='0px';
      sec.insertAdjacentElement('afterend',ph1);
      btn.insertAdjacentElement('afterend',ph2);

      function hoff(){
        var h=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var a=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var n=document.querySelector('.header__navigation'); var nh=0;
        if(n){var cs=getComputedStyle(n); if(cs.display!=='none'&&/(fixed|sticky)/.test(cs.position)) nh=n.offsetHeight;}
        return (h?h.offsetHeight:0)+(a&&getComputedStyle(a).display!=='none'?a.offsetHeight:0)+nh;
      }

      var s1=0, s2=0, H=0;

      function measure(){
        [sec,btn].forEach(function(el){ el.style.position=''; el.style.top=''; el.style.left=''; el.style.right=''; el.style.width=''; el.style.zIndex=''; });
        ph1.style.height=sec.offsetHeight+'px'; ph2.style.height=btn.offsetHeight+'px';
        H=hoff(); var st=window.pageYOffset||document.documentElement.scrollTop;
        s1=sec.getBoundingClientRect().top+st; s2=btn.getBoundingClientRect().top+st;
      }

      function stick(el,start,z){
        var st=window.pageYOffset||document.documentElement.scrollTop;
        if(st+H>start){ el.style.position='fixed'; el.style.top=H+'px'; el.style.left=0; el.style.right=0; el.style.width='100%'; el.style.zIndex=z; el.style.background='var(--color-background, #fff)'; }
        else { el.style.position=''; el.style.top=''; el.style.left=''; el.style.right=''; el.style.width=''; el.style.zIndex=''; el.style.background=''; }
      }

      function styleDrawer(){
        if(!mq.matches) return;
        var open=drawer.hasAttribute('open')||drawer.classList.contains('is-open');
        var off=hoff();
        if(open){
          drawer.style.position='fixed'; drawer.style.top=off+'px'; drawer.style.left=0; drawer.style.right=0;
          drawer.style.height='calc(100vh - '+off+'px)'; drawer.style.maxHeight=drawer.style.height;
          drawer.style.overflow='auto'; drawer.style.webkitOverflowScrolling='touch'; drawer.style.zIndex=DRZ;
          btn.style.zIndex=BTN;
        }else{
          drawer.style.position='fixed'; drawer.style.top=off+'px'; drawer.style.left='0'; drawer.style.right='0';
          drawer.style.height='0'; drawer.style.maxHeight='0'; drawer.style.overflow='hidden'; drawer.style.width='0';
          drawer.style.opacity='0'; drawer.style.visibility='hidden'; drawer.style.pointerEvents='none'; drawer.style.zIndex=DRZ;
        }
      }

      function tick(){
        if(!mq.matches){ [sec,btn].forEach(function(el){ el.style=''; }); ph1.style.height='0px'; ph2.style.height='0px'; return; }
        stick(sec,s1,SEC); stick(btn,s2,BTN); styleDrawer();
      }

      window.addEventListener('load',function(){ measure(); tick(); });
      window.addEventListener('resize',function(){ measure(); tick(); });
      window.addEventListener('scroll',tick,{passive:true});
      new MutationObserver(styleDrawer).observe(drawer,{attributes:true});
    })();
    </script>

    <script>
    (function(){
      var TITLE_Z=9, BUF=1;
      function hoff(){
        var h=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var a=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var n=document.querySelector('.header__navigation'); var nh=0;
        if(n){var cs=getComputedStyle(n); if(cs.display!=='none'&&/(fixed|sticky)/.test(cs.position)) nh=n.offsetHeight;}
        var desk=window.matchMedia('(min-width: 990px)').matches;
        // return (h?h.offsetHeight:0)+(a&&getComputedStyle(a).display!=='none'?a.offsetHeight:0)+nh+(desk?100:0);
      }
      function fTop(){
        var f=document.querySelector('#shopify-section-footer, .footer, .site-footer, footer'); if(!f) return 1/0;
        var r=f.getBoundingClientRect(); return r.top+(window.pageYOffset||document.documentElement.scrollTop);
      }
      var els=[].slice.call(document.querySelectorAll('.shopify-section.title-carousel.with-spacing')); if(!els.length) return;
      var ms=els.map(function(el){ var ph=document.createElement('div'); ph.style.height='0px'; el.insertAdjacentElement('afterend',ph); return {el:el, ph:ph, s:0, stop:0, H:0}; });

      function measure(m){
        var el=m.el; el.style.position=''; el.style.top=''; el.style.left=''; el.style.right=''; el.style.width=''; el.style.zIndex=''; el.style.background='';
        // m.ph.style.height=el.offsetHeight+'px'; m.H=hoff();
        var st=window.pageYOffset||document.documentElement.scrollTop; var box=el.getBoundingClientRect();
        m.s=box.top+st; m.stop=fTop()-BUF;
      }
      function apply(m){
        var el=m.el, y=window.pageYOffset||document.documentElement.scrollTop, H=m.H, h=el.offsetHeight;
        if(y+H<=m.s){ if(el.style.position==='fixed'||el.style.position==='absolute'){ el.style.position=''; el.style.top=''; el.style.left=''; el.style.right=''; el.style.width=''; el.style.zIndex=''; el.style.background=''; } return; }
        if(y+H+h>=m.stop){ var pt=el.parentElement.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop); el.style.position='absolute'; el.style.top=((m.stop-h)-pt)+'px'; el.style.left='0'; el.style.right='0'; el.style.width='100%'; el.style.zIndex=TITLE_Z; el.style.background='var(--color-background, #fff)'; return; }
        el.style.position='fixed'; el.style.top=H+'60px'; el.style.left='0'; el.style.right='0'; el.style.width='100%'; el.style.zIndex=TITLE_Z; el.style.background='var(--color-background, #fff)';
      }
      function recalc(){ ms.forEach(measure); ms.forEach(apply); }
      window.addEventListener('load',recalc,{passive:true});
      window.addEventListener('resize',recalc,{passive:true});
      window.addEventListener('orientationchange',recalc,{passive:true});
      window.addEventListener('scroll',function(){ var o=ms[0].H, n=hoff(); if(Math.abs(n-o)>2) ms.forEach(measure); ms.forEach(apply); },{passive:true});
      recalc();
    })();
</script>

{% schema %}
{
  "name": "Collection sticky filters",
  "tag": "section",
  "class": "collection-grid-section with-spacing",
  "settings": [
    { "type": "range", "id": "products_per_page", "min": 8, "max": 24, "step": 4, "default": 16, "label": "Products per page" },
    { "type": "select", "id": "image_ratio", "options": [
      { "value": "adapt", "label": "Adapt" },
      { "value": "portrait", "label": "Portrait" },
      { "value": "square", "label": "Square" } ],
      "default": "adapt", "label": "Image ratio" },
    { "type": "checkbox", "id": "show_secondary_image", "default": false, "label": "Show secondary image" },
    { "type": "checkbox", "id": "add_image_padding", "default": false, "label": "Add image padding" },
    { "type": "checkbox", "id": "show_image_outline", "default": true, "label": "Show image outline" },
    { "type": "checkbox", "id": "show_vendor", "default": false, "label": "Show vendor" },
    { "type": "checkbox", "id": "show_rating", "default": false, "label": "Show rating" },
    { "type": "checkbox", "id": "enable_filtering", "default": true, "label": "Enable filtering" },
    { "type": "checkbox", "id": "enable_sorting", "default": true, "label": "Enable sorting" },
    { "type": "checkbox", "id": "collapse_on_larger_devices", "default": false, "label": "Collapse on larger devices" }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        },
          {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ]
}
{% endschema %}