{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-product-grid.css' | asset_url | stylesheet_tag }}
{{ 'component-collection-filters.css' | asset_url | stylesheet_tag }}
{{ 'component-sticky-collection-filters.css' | asset_url | stylesheet_tag }}

<style>
  @media screen and (max-width: 768px) {

  #ProductGridContainer {
    margin: 0 0 24px;
  }

}

.sticky-filters-bar {
  --filter-bg-color: {{ section.settings.bg_color }};
  --filter-text-color: {{ section.settings.text_color }};
}

</style>

<script src="{{ 'collection-filters.js' | asset_url }}" defer="defer"></script>

{% assign active_tags = '' %}
{% for tag in current_tags %}
  {% assign tag_as_handle = tag | replace: '&#39;', '' | replace: '&#34;', '' | handle %}
  {% assign active_tags = active_tags | append: tag_as_handle %}
  {% unless forloop.last %}{% assign active_tags = active_tags | append: '+' %}{% endunless %}
{% endfor %}

<link rel="preload" href="{{ 'component-rte.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">

<div class="page-width">
  <div class="collection-grid__inner">

    <div id="sticky-wrap-{{ section.id }}" class="sticky-filters-wrap" data-section-id="{{ section.id }}">
      <div id="sticky-bar-{{ section.id }}" class="sticky-filters-bar" role="region" aria-label="Collection filters">
        {% if section.blocks.size > 0 %}
          <div class="head-slide-wrap title-carousel" id="head-slide-wrap">
            <ul class="head-slide">
              {%- capture contentForQuerystring -%}{{ content_for_header }}{%- endcapture -%}
                {%- assign pageUrl = contentForQuerystring
                  | split: '"pageurl":"'
                  | last
                  | split: '"'
                  | first
                  | split: '.myshopify.com'
                  | last
                  | replace: '\/', '/'
                  | replace: '%20', ' '
                  | replace: '\u0026', '&'
              -%}
              {% capture finalurl %}https://{{ pageUrl }}{% endcapture %}

              {%- assign key_and_value = pageUrl | split:'?' -%}

              {% for block in section.blocks %}
                <li {% if block.settings.link contains key_and_value[1] %} class="active" {% endif %}><a href="{{ block.settings.link }}">{{ block.settings.title }}</a></li> 
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="sticky-filters-bar__inner">
          {% render 'collection-filters' %}
        </div>
      </div>
      <div id="sticky-placeholder-{{ section.id }}" class="sticky-filters-placeholder" aria-hidden="true"></div>
    </div>

    <div id="ProductGridContainer">
      {% if collection.products.size == 0 %}
        <div class="collection collection--empty" id="product-grid" data-id="{{ section.id }}">
          <div class="loading-overlay gradient"></div>
          <div class="title-wrapper center">
            <h2 class="title title--primary">
              {{ 'sections.collection_template.empty' | t -}}
              <br>
              {{ 'sections.collection_template.use_fewer_filters_html' | t }}
              <button onclick="clearAll(event)" class="h2 collection-filter-clear-all">clear all</button>.
            </h2>
          </div>
        </div>
      {% else %}
        <div class="collection">
          {% paginate collection.products by 50 %}
            <ul id="product-grid" data-id="{{ section.id }}" class="product-grid product-grid-4 list-unstyled">
              {% for product in collection.products %}
                {% for collection in product.collections %}
                  {% if collection.title contains ' |' %}
                    {% assign grouped_collection = collection %}
                  {% endif %}
                {% endfor %}
                <li class="product-grid__item">
                  {% render 'grouped-product-card-4',
                    product_card_product: product,
                    collection: grouped_collection,
                    title: grouped_collection.title,
                    button_text: 'Shop Now',
                    forloop_index: forloop.index
                  %}
                </li>
              {% endfor %}
            </ul>

            <div id="load-more-wrapper" class="load-more-wrapper">
              {% if paginate.pages > 1 and paginate.next %}
                <load-more role="button" class="button" data-load-more="{{ paginate.next.url }}">
                  <span>Load more</span>
                  <div class="loading-overlay__spinner">
                    <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </load-more>
              {% endif %}
            </div>
          {% endpaginate %}
        </div>
      {% endif %}
    </div>

    <div class="loading-overlay">
      <div class="loading-overlay__spinner">
        <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
          <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
        </svg>
      </div>
    </div>

  </div>
</div>


  <script>
    /**
    * Check if the next sibling(s) of a given element are in the viewport
    * @param {Element} el - The reference element
    * @param {number} offset - Optional offset to tweak visibility detection
    * @returns {boolean} - true if any next sibling is in viewport
    */
    function isNextSiblingInViewport(el, offset = 0) {
      if (!el) return false;
      let sibling = el.nextElementSibling;

      while (sibling) {
        const rect = sibling.getBoundingClientRect();
        if ((rect.top + 100) + offset < window.innerHeight && rect.bottom > 0) {
          return true; // this sibling is in viewport
        }
        sibling = sibling.nextElementSibling;
      }

      return false; // no siblings in viewport
    }

    /**
     * Manages sticky behavior for filter bar on desktop and tablet viewports
     * Handles positioning relative to header, footer, and viewport scroll
     */
    window.scrollUtils1 = function() {
      var stickyWrapper=document.getElementById('sticky-wrap-{{ section.id }}');
      var stickyBar=document.getElementById('sticky-bar-{{ section.id }}');
      var placeholder=document.getElementById('sticky-placeholder-{{ section.id }}');
      var productGrid = document.getElementById('ProductGridContainer'), filterBar = document.querySelector('.sticky-filters-bar');
      if(window.screen.availWidth > 768) productGrid.style.minHeight = `${filterBar.clientHeight}px`;
      
      if(!stickyWrapper||!stickyBar||!placeholder) return;

      // Calculate total header offset height including announcement bar and navigation
      function calculateHeaderOffset(){
        var header=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var announcementBar=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var navigation=document.querySelector('.header__navigation'); 
        var bxCreative=document.querySelector(".bx-creative");
        var navigationHeight=0;
        if(navigation){var computedStyle=getComputedStyle(navigation); if(computedStyle.display!=='none'&&/(fixed|sticky)/.test(computedStyle.position)&&window.matchMedia('(min-width: 990px)').matches) navigationHeight=navigation.offsetHeight;}
        return (header?header.offsetHeight:0)+(bxCreative?bxCreative.offsetHeight:0)+(announcementBar&&getComputedStyle(announcementBar).display!=='none'?announcementBar.offsetHeight:0)+navigationHeight+88;
      }

      var endSentinel=document.getElementById('sticky-end-sentinel-{{ section.id }}');
      if(!endSentinel){ endSentinel=document.createElement('div'); endSentinel.id='sticky-end-sentinel-{{ section.id }}'; endSentinel.style.height='1px'; (document.getElementById('ProductGridContainer')||stickyWrapper.parentElement).parentNode.insertBefore(endSentinel,(document.getElementById('ProductGridContainer')||stickyWrapper.parentElement).nextSibling); }

      var startY=0, endY=0, headerOffset=0, fixedLeft=0, fixedWidth=0, stopPosition=0;

      // Get footer top position for boundary calculation
      function getFooterTop(){
        var footer=document.querySelector('#shopify-section-footer, .footer, .site-footer, footer');
        if(!footer) return 1/0;
        var rect=footer.getBoundingClientRect();
        return rect.top+(window.pageYOffset||document.documentElement.scrollTop);
      }

      // Measure and cache position values for sticky calculations
      function measurePositions(){
        stickyBar.style.position='static'; stickyBar.style.left=''; stickyBar.style.width=''; stickyBar.style.top=''; stickyBar.style.transform=''; stickyBar.classList.remove('is-fixed','is-docked');
        if(document.querySelector('.collection-filters__button')){
          placeholder.style.height=document.querySelector('.collection-filters__button').offsetHeight+'px';
        }
        headerOffset=calculateHeaderOffset();
        // console.log('offset height:', headerOffset);
        var scrollTop=window.pageYOffset||document.documentElement.scrollTop;
        startY=stickyWrapper.getBoundingClientRect().top+scrollTop;
        if(window.innerWidth < 769){
          startY=stickyWrapper.getBoundingClientRect().top+scrollTop+80;
        }
        endY=endSentinel.getBoundingClientRect().top+scrollTop;
        stopPosition=Math.min(endY,getFooterTop())-1;
        var rect=stickyBar.getBoundingClientRect(); fixedLeft=rect.left+window.pageXOffset; fixedWidth=rect.width;
        stickyBar.dataset.fixedLeft=fixedLeft; stickyBar.dataset.fixedWidth=fixedWidth;
      }

      // Apply sticky positioning based on scroll position
      function applyStickyBehavior(){   
        var scrollY=window.pageYOffset||document.documentElement.scrollTop, barHeight=stickyBar.offsetHeight;
        if(scrollY+headerOffset<=startY){ if(stickyBar.classList.contains('is-fixed')||stickyBar.classList.contains('is-docked')){ stickyBar.style.position='static'; stickyBar.style.left=''; stickyBar.style.width=''; stickyBar.style.top=''; stickyBar.style.transform=''; stickyBar.classList.remove('is-fixed','is-docked'); } return; }
        var nextElement = document.querySelector('.collection-grid-section');
        var cachedWidth=parseFloat(stickyBar.dataset.fixedWidth)||stickyBar.getBoundingClientRect().width;
        var cachedLeft=parseFloat(stickyBar.dataset.fixedLeft)||(stickyBar.getBoundingClientRect().left+window.pageXOffset);
        if(scrollY+headerOffset+barHeight>=stopPosition){
          var wrapperTop=stickyWrapper.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop);
          
          if (isNextSiblingInViewport(nextElement)) {
            stickyBar.style.position='static';
            stickyBar.classList.remove('is-fixed','is-docked');
            return;
          }
          stickyBar.style.position='fixed'; stickyBar.style.zIndex='5'; stickyBar.style.top=headerOffset+'px'; stickyBar.style.left=cachedLeft+'px'; stickyBar.style.width=cachedWidth+'px'; stickyBar.style.transform=''; stickyBar.classList.remove('is-fixed'); stickyBar.classList.add('is-docked'); return;
        }
                
        // Block fixing if next element is in viewport
        if (isNextSiblingInViewport(nextElement)) {
          stickyBar.style.position = 'static';
          stickyBar.classList.remove('is-fixed', 'is-docked');
          return;
        }

        // Allow sticky
        stickyBar.style.position='fixed';
        stickyBar.style.zIndex='9';
        stickyBar.style.top=headerOffset+'px';
        stickyBar.style.left=cachedLeft+'px';
        stickyBar.style.width=cachedWidth+'px';
        stickyBar.classList.add('is-fixed');
        stickyBar.classList.remove('is-docked');
        if(window.innerWidth < 769){
          var nextElement = document.querySelector('.collection-grid-section');
          
          if (isNextSiblingInViewport(nextElement)) {
            stickyBar.style.position='static';
            stickyBar.classList.remove('is-fixed','is-docked');
            return;
          }

          stickyBar.style.position='fixed';
          stickyBar.style.zIndex='9';
          stickyBar.style.top=(parseFloat(headerOffset) - 88) + 'px';
          stickyBar.style.background='var(--color-background, #fff)';
          stickyBar.style.left=cachedLeft+'px';
          stickyBar.style.width='100%';
          stickyBar.classList.add('is-fixed');
          stickyBar.classList.remove('is-docked');
        }
      }

      // Recalculate measurements and apply positioning
      function recalculateAndApply(){ measurePositions(); applyStickyBehavior(); }
      window.addEventListener('load',recalculateAndApply,{passive:true});
      window.addEventListener('resize',recalculateAndApply,{passive:true});
      window.addEventListener('orientationchange',recalculateAndApply,{passive:true});
      window.addEventListener('scroll',function(){ var newHeaderOffset=calculateHeaderOffset(); if(Math.abs(newHeaderOffset-headerOffset)>2) measurePositions(); applyStickyBehavior(); },{passive:true});
      measurePositions(); applyStickyBehavior();

      window.clearAll=function(event){ event&&event.preventDefault(); document.querySelector('collection-filters')?.clearAllFilters?.(); };
    };
    window.scrollUtils1();
  </script>
  <script>
    /**
     * Manages sticky behavior for mobile filter drawer and button
     * Handles positioning and drawer open/close states on mobile viewports
     */
    window.scrollUtils2 = function() {
      var mobileMediaQuery=window.matchMedia('(max-width: 989px)');
      var HEADER_Z=200, DRAWER_Z=190, BUTTON_Z=120, SECTION_Z=110;
      var mainSection=document.querySelector('.head-slide-wrap--main');
      if(!mainSection) return;
      var filterButton=mainSection.querySelector('.collection-filters__button.hide-desktop');
      var filterDrawer=mainSection.querySelector('collection-filters');
      if(!filterButton||!filterDrawer) return;

      var sectionPlaceholder=document.createElement('div');
      var buttonPlaceholder=document.createElement('div');
      sectionPlaceholder.style.height='0px';
      buttonPlaceholder.style.height='0px';
      mainSection.insertAdjacentElement('afterend',sectionPlaceholder);
      filterButton.insertAdjacentElement('afterend',buttonPlaceholder);

      // Calculate header offset for fixed positioning
      function calculateHeaderOffset(){
        var header=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var announcementBar=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var navigation=document.querySelector('.header__navigation'); var navigationHeight=0;
        if(navigation){var computedStyle=getComputedStyle(navigation); if(computedStyle.display!=='none'&&/(fixed|sticky)/.test(computedStyle.position)) navigationHeight=navigation.offsetHeight;}
        return (header?header.offsetHeight:0)+(announcementBar&&getComputedStyle(announcementBar).display!=='none'?announcementBar.offsetHeight:0)+navigationHeight;
      }

      var sectionStartY=0, buttonStartY=0, headerOffset=0;

      // Measure element positions and set placeholder heights
      function measurePositions(){
        [mainSection,filterButton].forEach(function(element){ element.style.position=''; element.style.top=''; element.style.left=''; element.style.right=''; element.style.width=''; element.style.zIndex=''; });
        sectionPlaceholder.style.height=mainSection.offsetHeight+'px'; buttonPlaceholder.style.height=filterButton.offsetHeight+'px';
        headerOffset=calculateHeaderOffset(); var scrollTop=window.pageYOffset||document.documentElement.scrollTop;
        sectionStartY=mainSection.getBoundingClientRect().top+scrollTop; buttonStartY=filterButton.getBoundingClientRect().top+scrollTop;
      }

      // Apply sticky positioning to element based on scroll
      function applySticky(element,startPosition,zIndex){
        var scrollTop=window.pageYOffset||document.documentElement.scrollTop;
        if(scrollTop+headerOffset>startPosition){ element.style.position='fixed'; element.style.top=headerOffset+'px'; element.style.left=0; element.style.right=0; element.style.width='100%'; element.style.zIndex=zIndex; element.style.background='var(--color-background, #fff)'; }
        else { element.style.position=''; element.style.top=''; element.style.left=''; element.style.right=''; element.style.width=''; element.style.zIndex=''; element.style.background=''; }
      }

      // Style filter drawer based on open/close state
      function styleDrawerState(){
        if(!mobileMediaQuery.matches) return;
        var isOpen=filterDrawer.hasAttribute('open')||filterDrawer.classList.contains('is-open');
        var currentOffset=calculateHeaderOffset();
        if(isOpen){
          filterDrawer.style.position='fixed'; filterDrawer.style.top=currentOffset+'px'; filterDrawer.style.left=0; filterDrawer.style.right=0;
          filterDrawer.style.height='calc(100vh - '+currentOffset+'px)'; filterDrawer.style.maxHeight=filterDrawer.style.height;
          filterDrawer.style.overflow='auto'; filterDrawer.style.webkitOverflowScrolling='touch'; filterDrawer.style.zIndex=DRAWER_Z;
          filterButton.style.zIndex=BUTTON_Z;
        }else{
          filterDrawer.style.position='fixed'; filterDrawer.style.top=currentOffset+'px'; filterDrawer.style.left='0'; filterDrawer.style.right='0';
          filterDrawer.style.height='0'; filterDrawer.style.maxHeight='0'; filterDrawer.style.overflow='hidden'; filterDrawer.style.width='0';
          filterDrawer.style.opacity='0'; filterDrawer.style.visibility='hidden'; filterDrawer.style.pointerEvents='none'; filterDrawer.style.zIndex=DRAWER_Z;
        }
      }

      // Update sticky states on scroll or resize
      function updateStickyStates(){
        if(!mobileMediaQuery.matches){ [mainSection,filterButton].forEach(function(element){ element.style=''; }); sectionPlaceholder.style.height='0px'; buttonPlaceholder.style.height='0px'; return; }
        applySticky(mainSection,sectionStartY,SECTION_Z); applySticky(filterButton,buttonStartY,BUTTON_Z); styleDrawerState();
      }

      window.addEventListener('load',function(){ measurePositions(); updateStickyStates(); });
      window.addEventListener('resize',function(){ measurePositions(); updateStickyStates(); });
      window.addEventListener('scroll',updateStickyStates,{passive:true});
      new MutationObserver(styleDrawerState).observe(filterDrawer,{attributes:true});
    };
    window.scrollUtils2();
  </script>
  <script>
    /**
     * Manages sticky behavior for title carousel sections
     * Handles positioning relative to header and footer boundaries
     */
    window.scrollUtils3 = function() {
      var TITLE_Z_INDEX=9, BOUNDARY_BUFFER=1;

      // Calculate header offset height
      function calculateHeaderOffset(){
        var header=document.querySelector('#shopify-section-header, .header-wrapper, header[role="banner"]');
        var announcementBar=document.querySelector('#shopify-section-announcement-bar, .announcement-bar');
        var navigation=document.querySelector('.header__navigation'); var navigationHeight=0;
        if(navigation){var computedStyle=getComputedStyle(navigation); if(computedStyle.display!=='none'&&/(fixed|sticky)/.test(computedStyle.position)) navigationHeight=navigation.offsetHeight;}
        var isDesktop=window.matchMedia('(min-width: 990px)').matches;
        // return (header?header.offsetHeight:0)+(announcementBar&&getComputedStyle(announcementBar).display!=='none'?announcementBar.offsetHeight:0)+navigationHeight+(isDesktop?100:0);
      }

      // Get footer top position
      function getFooterTop(){
        var footer=document.querySelector('#shopify-section-footer, .footer, .site-footer, footer'); if(!footer) return 1/0;
        var rect=footer.getBoundingClientRect(); return rect.top+(window.pageYOffset||document.documentElement.scrollTop);
      }

      var titleElements=[].slice.call(document.querySelectorAll('.shopify-section.title-carousel.with-spacing')); if(!titleElements.length) return;
      var measurements=titleElements.map(function(element){ var placeholder=document.createElement('div'); placeholder.style.height='0px'; element.insertAdjacentElement('afterend',placeholder); return {el:element, ph:placeholder, s:0, stop:0, H:0}; });

      // Measure position values for each title element
      function measureElement(measurement){
        var element=measurement.el; element.style.position=''; element.style.top=''; element.style.left=''; element.style.right=''; element.style.width=''; element.style.zIndex=''; element.style.background='';
        // measurement.ph.style.height=element.offsetHeight+'px'; measurement.H=calculateHeaderOffset();
        var scrollTop=window.pageYOffset||document.documentElement.scrollTop; var boundingBox=element.getBoundingClientRect();
        measurement.s=boundingBox.top+scrollTop; measurement.stop=getFooterTop()-BOUNDARY_BUFFER;
      }

      // Apply sticky positioning to title element
      function applyTitleSticky(measurement){
        var element=measurement.el, scrollY=window.pageYOffset||document.documentElement.scrollTop, headerHeight=measurement.H, elementHeight=element.offsetHeight;
        var nextElement = document.querySelector('.collection-grid-section');
          
        if (isNextSiblingInViewport(nextElement)) {
          b.style.position='static';
          b.classList.remove('is-fixed','is-docked');
          return;
        }

        if(scrollY+headerHeight<=measurement.s){ if(element.style.position==='fixed'||element.style.position==='absolute'){ element.style.position=''; element.style.top=''; element.style.left=''; element.style.right=''; element.style.width=''; element.style.zIndex=''; element.style.background=''; } return; }
        
        if(scrollY+headerHeight+elementHeight>=measurement.stop){ var parentTop=element.parentElement.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop); element.style.position='absolute'; element.style.top=((measurement.stop-elementHeight)-parentTop)+'px'; element.style.left='0'; element.style.right='0'; element.style.width='100%'; element.style.zIndex=TITLE_Z_INDEX; element.style.background='var(--color-background, #fff)'; return; }
        element.style.position='fixed'; element.style.top=headerHeight+'60px'; element.style.left='0'; element.style.right='0'; element.style.width='100%'; element.style.zIndex=TITLE_Z_INDEX; element.style.background='var(--color-background, #fff)';
      }

      // Recalculate all measurements and apply positioning
      function recalculateAll(){ measurements.forEach(measureElement); measurements.forEach(applyTitleSticky); }
      window.addEventListener('load',recalculateAll,{passive:true});
      window.addEventListener('resize',recalculateAll,{passive:true});
      window.addEventListener('orientationchange',recalculateAll,{passive:true});
      window.addEventListener('scroll',function(){ var oldOffset=measurements[0].H, newOffset=calculateHeaderOffset(); if(Math.abs(newOffset-oldOffset)>2) measurements.forEach(measureElement); measurements.forEach(applyTitleSticky); },{passive:true});
      recalculateAll();
    };
    window.scrollUtils3();
  </script>
  
{% schema %}
{
  "name": "Collection sticky filters",
  "tag": "section",
  "class": "collection-grid-section with-spacing",
  "settings": [
    { "type": "range", "id": "products_per_page", "min": 8, "max": 24, "step": 4, "default": 16, "label": "Products per page" },
    { "type": "select", "id": "image_ratio", "options": [
      { "value": "adapt", "label": "Adapt" },
      { "value": "portrait", "label": "Portrait" },
      { "value": "square", "label": "Square" } ],
      "default": "adapt", "label": "Image ratio" },
    {
      "type": "header",
      "content": "Fiter colors"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#546B82"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    { "type": "checkbox", "id": "show_secondary_image", "default": false, "label": "Show secondary image" },
    { "type": "checkbox", "id": "add_image_padding", "default": false, "label": "Add image padding" },
    { "type": "checkbox", "id": "show_image_outline", "default": true, "label": "Show image outline" },
    { "type": "checkbox", "id": "show_vendor", "default": false, "label": "Show vendor" },
    { "type": "checkbox", "id": "show_rating", "default": false, "label": "Show rating" },
    { "type": "checkbox", "id": "enable_filtering", "default": true, "label": "Enable filtering" },
    { "type": "checkbox", "id": "enable_sorting", "default": true, "label": "Enable sorting" },
    { "type": "checkbox", "id": "collapse_on_larger_devices", "default": false, "label": "Collapse on larger devices" }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        },
          {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ]
}
{% endschema %}