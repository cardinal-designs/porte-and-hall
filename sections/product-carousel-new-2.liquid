{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{% style %}
  .product-card .product-card__metafield-style {
    background: #546b82;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 24px;
    text-transform: uppercase;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 27%;
  }

  .product-carousel .swiper-button-next {
    right: 0;
  }

 .product-card__price.body.blue {
    margin-top: -12px;
  }

  
  .product-carousel__container-new-2 .product-card__swatches {
    margin: 0;
  }

  @media screen and (max-width: 768px) {
    .product-carousel__container-new-2 {
      margin-left: 0;
      margin-right: 0;
      width: 100% !important;
    }
  }
  
  @media screen and (max-width: 575px) {
    .product-carousel .swiper-button-next {
      right: 18px;
    }

    .product-card__image {
      aspect-ratio: 0.9;
    }

    .product-card {
      gap: 5px;
    }

    .product-card__price.body.blue {
      margin-top: -5px;
      font-size: 13px;
      letter-spacing: .3px;
    }

    .product-card__title {
      font-size: 13px;
      letter-spacing: 0;
    }

     .product-card__title span {
      font-size: 13px;
      letter-spacing: 0;
    }

    .product-carousel__container-new-2 {
      height: 300px !important;
    }
  
    .product-carousel__container-new-2 .swiper-pagination {
      bottom: 20px !important;
    }

    .carousel-new-2__video {
      object-fit: cover;
      height: 100%;
    }
  }
  
 @media screen and (max-width: 500px) {
  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 19%;
  }
 }
{% endstyle %}

<div class="product-carousel__inner product-carousel__new">
  <div class="product-carousel__heading">
    <h2 class="blue">{{ section.settings.heading }}</h2>
  </div>

  <product-carousel-new-two>
    <div class="product-carousel__container-new product-carousel__container-new-2 product-carousel__container swiper">
      <div class="swiper-wrapper">
        {% for product in section.settings.collection.products limit: 4 %}
          {% for collection in product.collections %}
            {% if collection.title contains ' |' %}
              {% assign grouped_collection = collection %}
            {% endif %}
          {% endfor %}
          <div class="product-carousel__item swiper-slide">
            {% if section.settings.product_card_type == 'standard_card' %}
            {% render 'grouped-product-card-2',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% else %}
            {% render 'grouped-product-card-3',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination product-carousel__pagination"></div>
    </div>
    {% if section.settings.btn_link != blank %}
    <a class="shop-all-btn" href="{{ section.settings.btn_link }}">SHOP ALL BEST SELLERS</a>
    {% endif %}
  </product-carousel-new-two>
</div>

<style>
  {% if section.settings.background != blank %}
    #shopify-section-{{section.id }}.product-carousel {
      background: {{ section.settings.background }};
    }
  {% endif %}
</style>

<script>
(function () {
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section) return;
  const videos = Array.from(section.querySelectorAll('video.carousel-new-2__video'));
  if (!videos.length) return;

  // ---------- Helpers ----------
  const isVisible = el => el.offsetParent !== null && getComputedStyle(el).visibility !== 'hidden';

  function extractImageURL(box) {
    if (!box) return '';
    // Prefer the first <img> in the image box (works for lazy-image output, picture/img, etc.)
    const img = box.querySelector('img') || box.querySelector('source') || null;
    if (img) {
      let url = img.currentSrc || img.src || img.getAttribute('data-src') || '';
      if (!url) {
        const ss = img.getAttribute('srcset') || img.getAttribute('data-srcset') || '';
        if (ss) {
          const first = ss.split(',')[0];
          if (first) url = first.trim().split(' ')[0];
        }
      }
      if (url) return url;
    }
    // Fallback: some themes set a background-image on a wrapper
    const bgEl = box.querySelector('[style*="background-image"]');
    if (bgEl) {
      const m = getComputedStyle(bgEl).backgroundImage.match(/url\(["']?(.+?)["']?\)/);
      if (m && m[1]) return m[1];
    }
    return '';
  }

  function ensureContainerStyles(box) {
    const cs = getComputedStyle(box);
    if (cs.position === 'static') box.style.position = 'relative';
  }

  function makeOverlayFor(videoEl) {
    const box = videoEl.closest('.product-card__image') || videoEl.parentElement;
    if (!box) return null;
    ensureContainerStyles(box);

    // reuse if already exists
    let ov = box.querySelector('.video-fallback');
    if (!ov) {
      ov = document.createElement('div');
      ov.className = 'video-fallback';
      ov.style.position = 'absolute';
      ov.style.inset = '0';
      ov.style.backgroundSize = 'cover';
      ov.style.backgroundPosition = 'center';
      ov.style.backgroundRepeat = 'no-repeat';
      ov.style.transition = 'opacity 180ms ease';
      ov.style.opacity = '1';
      ov.style.zIndex = '2'; // ON TOP of the video
      box.appendChild(ov);
    }

    const url = extractImageURL(box);
    if (url) ov.style.backgroundImage = `url("${url}")`;

    // Make sure the video sits underneath and covers
    Object.assign(videoEl.style, {
      position: 'absolute',
      inset: '0',
      width: '100%',
      height: '100%',
      objectFit: 'cover',
      zIndex: '1',
      background: 'transparent'
    });

    return ov;
  }

  function showOverlay(ov) { if (ov) { ov.style.opacity = '1'; ov.style.pointerEvents = 'none'; } }
  function hideOverlay(ov) { if (ov) { ov.style.opacity = '0'; ov.style.pointerEvents = 'none'; } }

  // ---------- Prep videos + overlays ----------
  const overlayMap = new Map(); // video -> overlay

  videos.forEach(v => {
    // neutralize attributes we don't want but keep your Liquid output
    v.removeAttribute('loop');     // MUST be off to get 'ended'
    v.muted = true;
    v.autoplay = false;            // weâ€™ll control start
    v.playsInline = true;
    v.preload = v.preload || 'metadata';

    const ov = makeOverlayFor(v);
    overlayMap.set(v, ov);
    showOverlay(ov);

    // User interactions (if they tap)
    v.addEventListener('play', () => {
      videos.forEach(other => {
        if (other !== v) { try { other.pause(); } catch(_) {}; showOverlay(overlayMap.get(other)); }
      });
      hideOverlay(overlayMap.get(v));
    }, { passive: true });

    v.addEventListener('pause', () => {
      if (!v.ended) showOverlay(overlayMap.get(v));
    }, { passive: true });
  });

  // ---------- Sequencing ----------
  const visibleVideos = () => videos.filter(isVisible);
  let seq = [], idx = 0;

  function rebuild() {
    seq = visibleVideos();
    if (idx >= seq.length) idx = 0;
  }

  function playAt(i) {
    rebuild();
    if (!seq.length) return;

    idx = (i + seq.length) % seq.length;
    const current = seq[idx];

    // others -> pause + overlay
    videos.forEach(v => { if (v !== current) { try { v.pause(); } catch(_) {}; showOverlay(overlayMap.get(v)); } });

    // this one -> hide overlay + play from 0
    hideOverlay(overlayMap.get(current));
    try { if (current.ended || current.currentTime > 0) current.currentTime = 0; } catch(_) {}
    const p = current.play();
    if (p && p.catch) p.catch(() => {}); // ignore autoplay promise errors

    // listen once
    seq.forEach(v => v.removeEventListener('ended', handleEnded));
    current.addEventListener('ended', handleEnded, { once: true });
  }

  function handleEnded() {
    const justEnded = seq[idx];
    if (justEnded) showOverlay(overlayMap.get(justEnded));
    playAt(idx + 1);
  }

  // viewport changes (mobile vs desktop)
  const mq = window.matchMedia('(max-width: 575px)');
  const onChange = () => { rebuild(); if (seq.length) playAt(idx); };
  if (mq && mq.addEventListener) mq.addEventListener('change', onChange);
  else window.addEventListener('resize', () => requestAnimationFrame(onChange));

  // ---------- Start ----------
  // show overlays on all, then begin
  videos.forEach(v => showOverlay(overlayMap.get(v)));

  const start = () => { rebuild(); if (seq.length) playAt(0); };
  if (videos.some(v => v.readyState < 1)) {
    let left = videos.length, started = false;
    const done = () => { if (!started && --left <= 0) { started = true; start(); } };
    videos.forEach(v => {
      if (v.readyState >= 1) done();
      else { v.addEventListener('loadedmetadata', done, { once: true }); setTimeout(done, 1200); }
    });
  } else {
    start();
  }
})();
</script>

{% schema %}
{
  "name": "Product Carousel New 2",
  "tag": "section",
  "class": "product-carousel with-spacing",
  "settings": [
    {
      "type": "textarea",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_metafield_style",
      "label": "Show metafield style",
      "default": false
    },    
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "product_card_type",
      "label": "Product Card Type",
      "options": [
        {
          "label": "Standard Card",
          "value": "standard_card"
        },
        {
          "label": "Video Card (metafield)",
          "value": "video_card"
        }
      ],
      "default": "standard_card"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "btn_link",
      "label": "Bottom Button Link"
    }
  ],
  "presets": [
    {
      "name": "Product Carousel New 2"
    }
  ]
}
{% endschema %}
