{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{% style %}
  .product-card .product-card__metafield-style {
    background: #546b82;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 24px;
    text-transform: uppercase;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 27%;
  }

  .product-carousel .swiper-button-next {
    right: 0;
  }

 .product-card__price.body.blue {
    margin-top: -12px;
  }

  
  .product-carousel__container-new-2 .product-card__swatches {
    margin: 0;
  }

  @media screen and (max-width: 768px) {
    .product-carousel__container-new-2 {
      margin-left: 0;
      margin-right: 0;
      width: 100% !important;
    }
  }
  
  @media screen and (max-width: 575px) {
    .product-carousel .swiper-button-next {
      right: 18px;
    }

    .product-card__image {
      aspect-ratio: 0.9;
    }

    .product-card {
      gap: 5px;
    }

    .product-card__price.body.blue {
      margin-top: -5px;
      font-size: 13px;
      letter-spacing: .3px;
    }

    .product-card__title {
      font-size: 13px;
      letter-spacing: 0;
    }

     .product-card__title span {
      font-size: 13px;
      letter-spacing: 0;
    }

    .product-carousel__container-new-2 {
      height: 300px !important;
    }
  
    .product-carousel__container-new-2 .swiper-pagination {
      bottom: 20px !important;
    }

    .carousel-new-2__video {
      object-fit: cover;
      height: 100%;
    }
  }
  
 @media screen and (max-width: 500px) {
  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 19%;
  }
 }

 .product-card__image { position: relative; }
.product-card__image video.carousel-new-2__video,
.product-card__image img.img-fill {
  position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
}
.product-card__image img.img-fill { transition: opacity 0.25s ease; }
{% endstyle %}

<div class="product-carousel__inner product-carousel__new">
  <div class="product-carousel__heading">
    <h2 class="blue">{{ section.settings.heading }}</h2>
  </div>

  <product-carousel-new-two>
    <div class="product-carousel__container-new product-carousel__container-new-2 product-carousel__container swiper">
      <div class="swiper-wrapper">
        {% for product in section.settings.collection.products limit: 4 %}
          {% for collection in product.collections %}
            {% if collection.title contains ' |' %}
              {% assign grouped_collection = collection %}
            {% endif %}
          {% endfor %}
          <div class="product-carousel__item swiper-slide">
            {% if section.settings.product_card_type == 'standard_card' %}
            {% render 'grouped-product-card-2',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% else %}
            {% render 'grouped-product-card-3',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination product-carousel__pagination"></div>
    </div>
    {% if section.settings.btn_link != blank %}
    <a class="shop-all-btn" href="{{ section.settings.btn_link }}">SHOP ALL BEST SELLERS</a>
    {% endif %}
  </product-carousel-new-two>
</div>

<style>
  {% if section.settings.background != blank %}
    #shopify-section-{{section.id }}.product-carousel {
      background: {{ section.settings.background }};
    }
  {% endif %}
</style>

<script>
(function () {
  // Scope to this section only
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section) return;

  // Collect only the videos for this carousel section.
  // NOTE: product card markup uses class `carousel-new-2__video` (and "hide-desktop" for desktop),
  // and (unfortunately) repeats id="video" — we'll ignore ids and use the class.
  const allVideos = Array.from(
    section.querySelectorAll('video.carousel-new-2__video')
  );

  if (!allVideos.length) return; // nothing to do if there are no videos

  // Helper: consider only *visible* videos (e.g., not hidden on desktop with .hide-desktop)
  const visibleVideos = () =>
    allVideos.filter(v => {
      // If element or any ancestor is display:none, offsetParent will be null.
      if (v.offsetParent === null) return false;
      // Additionally guard against visibility:hidden
      const cs = getComputedStyle(v);
      return cs.visibility !== 'hidden' && cs.display !== 'none' && cs.opacity !== '0';
    });

  // Ensure only one is ever playing
  function pauseOthers(except) {
    allVideos.forEach(v => {
      if (v !== except) {
        try { v.pause(); } catch (e) {}
      }
    });
  }

  // Prepare videos: turn off loop (Liquid set loop:true), force muted/inline, and wire events
  allVideos.forEach(v => {
    v.loop = false;         // critical: we need 'ended' to fire
    v.muted = true;         // allow autoplay on most browsers
    v.autoplay = false;     // we'll control autoplay manually
    v.playsInline = true;   // iOS
    v.preload = v.preload || 'metadata';

    // If user manually taps a video, still enforce "only one at a time"
    v.addEventListener('play', () => pauseOthers(v), { passive: true });
  });

  let idx = 0;         // current index into the *visible* list
  let seq = [];        // cached list of visible videos in DOM order

  function rebuildSequence() {
    // Refresh the visible set (e.g., viewport size changed between mobile/desktop)
    seq = visibleVideos();
    // If current idx goes out of bounds after a resize, reset to 0
    if (idx >= seq.length) idx = 0;
  }

  function playAt(i) {
    rebuildSequence();
    if (!seq.length) return;

    idx = (i + seq.length) % seq.length;
    const current = seq[idx];

    // Make sure others are paused
    pauseOthers(current);

    try {
      // Some browsers need a seek to 0 to ensure we replay after 'ended'
      if (current.ended || current.currentTime > 0) current.currentTime = 0;
    } catch (e) {}

    // Try to play; ignore auto-play promise errors silently
    const p = current.play();
    if (p && typeof p.catch === 'function') p.catch(() => { /* ignore */ });

    // To avoid stacking multiple listeners, remove old then add once
    seq.forEach(v => v.removeEventListener('ended', handleEnded));
    current.addEventListener('ended', handleEnded, { once: true });
  }

  function handleEnded() {
    // Advance to the next visible video, wrapping to the start
    playAt(idx + 1);
  }

  // If the viewport changes (e.g., desktop ↔ mobile), the visible set changes
  const mq = window.matchMedia('(max-width: 575px)');
  if (mq && typeof mq.addEventListener === 'function') {
    mq.addEventListener('change', () => {
      // Rebuild and restart the sequence gracefully on viewport change
      rebuildSequence();
      playAt(idx);
    });
  } else {
    // Fallback: rebuild on resize
    window.addEventListener('resize', () => {
      // Throttle via rAF
      if (playAt._resizeTick) cancelAnimationFrame(playAt._resizeTick);
      playAt._resizeTick = requestAnimationFrame(() => {
        rebuildSequence();
        playAt(idx);
      });
    });
  }

  // Optional (nice-to-have): if your Swiper changes slides programmatically, keep enforcing single play
  section.addEventListener('click', (e) => {
    // If a user interacts with a visible video link/container, re-enforce "one playing"
    const vid = e.target.closest && e.target.closest('video.carousel-new-2__video');
    if (vid) pauseOthers(vid);
  }, { capture: true });

  // Kick it off on load: wait for metadata so durations are known
  // Start at the first visible video; if none visible yet (e.g. fonts/CLS), retry once on next tick
  const start = () => {
    rebuildSequence();
    if (!seq.length) {
      requestAnimationFrame(start);
      return;
    }
    // Ensure we listen for 'ended' from the very start
    seq.forEach(v => v.removeEventListener('ended', handleEnded));
    playAt(0);
  };

  // If all videos already have metadata, start immediately; otherwise wait
  const needMeta = allVideos.some(v => v.readyState < 1);
  if (needMeta) {
    let pending = allVideos.length, started = false;
    const onMeta = () => {
      pending -= 1;
      if (!started && pending <= 0) {
        started = true;
        start();
      }
    };
    allVideos.forEach(v => {
      if (v.readyState >= 1) {
        onMeta();
      } else {
        v.addEventListener('loadedmetadata', onMeta, { once: true });
        // Safety timeout in case some never fire
        setTimeout(onMeta, 1500);
      }
    });
  } else {
    start();
  }
})();
</script>

{% schema %}
{
  "name": "Product Carousel New 2",
  "tag": "section",
  "class": "product-carousel with-spacing",
  "settings": [
    {
      "type": "textarea",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_metafield_style",
      "label": "Show metafield style",
      "default": false
    },    
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "product_card_type",
      "label": "Product Card Type",
      "options": [
        {
          "label": "Standard Card",
          "value": "standard_card"
        },
        {
          "label": "Video Card (metafield)",
          "value": "video_card"
        }
      ],
      "default": "standard_card"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "btn_link",
      "label": "Bottom Button Link"
    }
  ],
  "presets": [
    {
      "name": "Product Carousel New 2"
    }
  ]
}
{% endschema %}
