{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{% style %}
  .product-card .product-card__metafield-style {
    background: #546b82;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 24px;
    text-transform: uppercase;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 27%;
  }

  .product-carousel .swiper-button-next {
    right: 0;
  }

 .product-card__price.body.blue {
    margin-top: -12px;
  }

  
  .product-carousel__container-new-2 .product-card__swatches {
    margin: 0;
  }

  @media screen and (max-width: 768px) {
    .product-carousel__container-new-2 {
      margin-left: 0;
      margin-right: 0;
      width: 100% !important;
    }
  }
  
  @media screen and (max-width: 575px) {
    .product-carousel .swiper-button-next {
      right: 18px;
    }

    .product-card__image {
      aspect-ratio: 0.9;
    }

    .product-card {
      gap: 5px;
    }

    .product-card__price.body.blue {
      margin-top: -5px;
      font-size: 13px;
      letter-spacing: .3px;
    }

    .product-card__title {
      font-size: 13px;
      letter-spacing: 0;
    }

     .product-card__title span {
      font-size: 13px;
      letter-spacing: 0;
    }

    .product-carousel__container-new-2 {
      height: 300px !important;
    }
  
    .product-carousel__container-new-2 .swiper-pagination {
      bottom: 20px !important;
    }

    .carousel-new-2__video {
      object-fit: cover;
      height: 100%;
    }
  }
  
 @media screen and (max-width: 500px) {
  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 19%;
  }
 }
{% endstyle %}

<div class="product-carousel__inner product-carousel__new">
  <div class="product-carousel__heading">
    <h2 class="blue">{{ section.settings.heading }}</h2>
  </div>

  <product-carousel-new-two>
    <div class="product-carousel__container-new product-carousel__container-new-2 product-carousel__container swiper">
      <div class="swiper-wrapper">
        {% for product in section.settings.collection.products limit: 4 %}
          {% for collection in product.collections %}
            {% if collection.title contains ' |' %}
              {% assign grouped_collection = collection %}
            {% endif %}
          {% endfor %}
          {% assign only_one = false %}
          {% if product.handle contains 'wild-side' %}
            {% assign only_one = true %}
          {% endif %}
          <div class="product-carousel__item swiper-slide">
            {% if section.settings.product_card_type == 'standard_card' %}
            {% render 'grouped-product-card-2',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% else %}
            {% render 'grouped-product-card-3',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text,
              only_show_one: only_one
            %}
          {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination product-carousel__pagination"></div>
    </div>
    {% if section.settings.btn_link != blank %}
    <a class="shop-all-btn" href="{{ section.settings.btn_link }}">SHOP ALL BEST SELLERS</a>
    {% endif %}
  </product-carousel-new-two>
</div>

<style>
  {% if section.settings.background != blank %}
    #shopify-section-{{section.id }}.product-carousel {
      background: {{ section.settings.background }};
    }
  {% endif %}
</style>

<script>
(function () {
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section) return;

  const wrapper = section.querySelector('.swiper-wrapper');
  if (!wrapper) return;

  // --- store original order once (so desktop can revert) ---
  const originalSlides = Array.from(wrapper.children);
  originalSlides.forEach((slide, i) => (slide.dataset.originalIndex = i));

  const mq = window.matchMedia('(max-width: 575px)');
  let primaryVideo = null;   // the single mobile video we keep alive
  let keepAlive = null;

  function getSwiper() {
    const el = section.querySelector('.swiper');
    return el && el.swiper ? el.swiper : null;
  }

  // -------- ordering ----------
  function restoreDesktopOrder() {
    const ordered = Array.from(wrapper.children)
      .sort((a, b) => (+a.dataset.originalIndex) - (+b.dataset.originalIndex));
    ordered.forEach(n => wrapper.appendChild(n));
    const sw = getSwiper();
    if (sw) { sw.updateSlides(); sw.update(); }
  }

  function moveFirstVideoToFrontMobile() {
    // use non-duplicate slides to decide which to move
    const realSlides = Array.from(wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)'));
    const firstVideoSlide = realSlides.find(s => s.querySelector('video.carousel-new-2__video'));
    if (!firstVideoSlide) return;

    // If that original slide isn’t already first among wrapper children, move it
    if (wrapper.firstElementChild !== firstVideoSlide) {
      wrapper.insertBefore(firstVideoSlide, wrapper.firstElementChild);
      const sw = getSwiper();
      if (sw) { sw.updateSlides(); sw.update(); }
    }
  }

  // -------- video keep-alive (single video on mobile) ----------
  function pickPrimaryMobileVideo() {
    // Always target the first *real* slide’s video
    const realSlides = Array.from(wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)'));
    const vSlide = realSlides.find(s => s.querySelector('video.carousel-new-2__video'));
    return vSlide ? vSlide.querySelector('video.carousel-new-2__video') : null;
  }

  function ensureAutoplayFlags(v) {
    // Keep it minimal; don’t fight Liquid—just ensure mobile autoplay works
    v.muted = true; v.setAttribute('muted','');
    v.playsInline = true; v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
    v.loop = true;
    if (!v.preload) v.preload = 'auto';
  }

  function playVideo(v) {
    if (!v) return;
    // If it somehow ended, restart
    try { if (v.ended) v.currentTime = 0; } catch(_) {}
    const p = v.play && v.play();
    if (p && p.catch) {
      // small retry to get past swipe/gesture races
      setTimeout(() => { v.play && v.play().catch(()=>{}); }, 120);
    }
  }

  function startMobileVideo() {
    primaryVideo = pickPrimaryMobileVideo();
    if (!primaryVideo) return;

    ensureAutoplayFlags(primaryVideo);
    if (primaryVideo.readyState >= 1) {
      playVideo(primaryVideo);
    } else {
      primaryVideo.addEventListener('loadedmetadata', () => playVideo(primaryVideo), { once: true });
      setTimeout(() => { if (primaryVideo && primaryVideo.isConnected) playVideo(primaryVideo); }, 600);
    }

    // keep it alive: if swipes or browser pause it, resume
    if (keepAlive) clearInterval(keepAlive);
    keepAlive = setInterval(() => {
      if (!mq.matches) return;                // mobile only
      if (!primaryVideo || !primaryVideo.isConnected) {
        // DOM changed (slides cloned/reordered) → re-pick and resume
        primaryVideo = pickPrimaryMobileVideo();
        if (primaryVideo) { ensureAutoplayFlags(primaryVideo); playVideo(primaryVideo); }
        return;
      }
      if (primaryVideo.paused) playVideo(primaryVideo);
    }, 800);

    // re-assert after common Swiper events (lightweight)
    const sw = getSwiper();
    const refresh = () => { if (mq.matches) setTimeout(startMobileVideo, 40); };
    if (sw && sw.on && !sw._simpleKeepHook) {
      ['init','slideChange','update','resize','reachBeginning','reachEnd','setTranslate','setTransition']
        .forEach(ev => sw.on(ev, refresh));
      sw._simpleKeepHook = true;
    }
  }

  function stopMobileVideo() {
    if (keepAlive) { clearInterval(keepAlive); keepAlive = null; }
    if (primaryVideo) {
      try { primaryVideo.pause(); } catch(_) {}
      primaryVideo = null;
    }
  }

  // Desktop: do not play (videos already hidden by CSS class 'hide-desktop')
  function applyLayout() {
    if (mq.matches) {
      moveFirstVideoToFrontMobile();
      startMobileVideo();
    } else {
      stopMobileVideo();
      restoreDesktopOrder();
      // just in case, pause any playing videos
      section.querySelectorAll('video.carousel-new-2__video').forEach(v => { try { v.pause(); } catch(_) {} });
    }
  }

  // initial + on breakpoint change
  applyLayout();
  if (mq.addEventListener) mq.addEventListener('change', applyLayout);
  else mq.addListener(applyLayout);

  // resume after tab becomes visible again on mobile
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && mq.matches) startMobileVideo();
  });
})();
</script>

{% schema %}
{
  "name": "ProductCarouselNew2 (old)",
  "tag": "section",
  "class": "product-carousel with-spacing",
  "settings": [
    {
      "type": "textarea",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_metafield_style",
      "label": "Show metafield style",
      "default": false
    },    
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "product_card_type",
      "label": "Product Card Type",
      "options": [
        {
          "label": "Standard Card",
          "value": "standard_card"
        },
        {
          "label": "Video Card (metafield)",
          "value": "video_card"
        }
      ],
      "default": "standard_card"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "btn_link",
      "label": "Bottom Button Link"
    }
  ],
  "presets": [
    {
      "name": "ProductCarouselNew2 (old)"
    }
  ]
}
{% endschema %}
