{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{% style %}
  .product-card .product-card__metafield-style {
    background: #546b82;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 24px;
    text-transform: uppercase;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev { top: 27%; }
  .product-carousel .swiper-button-next { right: 0; }

  .product-card__price.body.blue { margin-top: -12px; }

  .product-carousel__container-new-2 .product-card__swatches { margin: 0; }

  @media screen and (max-width: 768px) {
    .product-carousel__container-new-2 {
      margin-left: 0; margin-right: 0; width: 100% !important;
    }
  }

  @media screen and (max-width: 575px) {
    .product-carousel .swiper-button-next { right: 18px; }

    .product-card__image { aspect-ratio: 0.9; }
    .product-card { gap: 5px; }

    .product-card__price.body.blue {
      margin-top: -5px; font-size: 13px; letter-spacing: .3px;
    }

    .product-card__title { font-size: 13px; letter-spacing: 0; }
    .product-card__title span { font-size: 13px; letter-spacing: 0; }

    .product-carousel__container-new-2 { height: 300px !important; }
    .product-carousel__container-new-2 .swiper-pagination { bottom: 20px !important; }

    .carousel-new-2__video { object-fit: cover; height: 100%; }
  }

  @media screen and (max-width: 500px) {
    .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev { top: 19%; }
  }
{% endstyle %}

<!-- z-index layering fix (scoped to this section id) -->
<style>
  #shopify-section-{{ section.id }} .product-card__image {
    position: relative !important; /* create stacking context */
  }
  #shopify-section-{{ section.id }} .product-card__image img {
    position: absolute !important;
    inset: 0 !important;
    z-index: 1 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }
  #shopify-section-{{ section.id }} video.carousel-new-2__video {
    position: absolute !important;
    inset: 0 !important;
    z-index: 10 !important;       /* above image */
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    display: block !important;     /* defeat any hide-desktop/mobile toggles */
    opacity: 1 !important;
  }
</style>

<div class="product-carousel__inner product-carousel__new">
  <div class="product-carousel__heading">
    <h2 class="blue">{{ section.settings.heading }}</h2>
  </div>

  <product-carousel-new-two>
    <div class="product-carousel__container-new product-carousel__container-new-2 product-carousel__container swiper">
      <div class="swiper-wrapper">
        {% for product in section.settings.collection.products limit: 4 %}
          {% for collection in product.collections %}
            {% if collection.title contains ' |' %}
              {% assign grouped_collection = collection %}
            {% endif %}
          {% endfor %}
          {% assign only_one = false %}
          {% if product.handle contains 'wild-side' %}
            {% assign only_one = true %}
          {% endif %}
          <div class="product-carousel__item swiper-slide">
            {% if section.settings.product_card_type == 'standard_card' %}
              {% render 'grouped-product-card-2',
                product_card_product: product,
                collection: grouped_collection,
                title: grouped_collection.title,
                button_text: section.settings.button_text
              %}
            {% else %}
              {% render 'grouped-product-card-3',
                product_card_product: product,
                collection: grouped_collection,
                title: grouped_collection.title,
                button_text: section.settings.button_text,
                only_show_one: only_one
              %}
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination product-carousel__pagination"></div>
    </div>
    {% if section.settings.btn_link != blank %}
      <a class="shop-all-btn" href="{{ section.settings.btn_link }}">SHOP ALL BEST SELLERS</a>
    {% endif %}
  </product-carousel-new-two>
</div>

<style>
  {% if section.settings.background != blank %}
    #shopify-section-{{ section.id }}.product-carousel { background: {{ section.settings.background }}; }
  {% endif %}
</style>

<script>
(function () {
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section) return;

  const wrapper = section.querySelector('.swiper-wrapper');
  if (!wrapper) return;

  // Save original order to restore on desktop
  const originalSlides = Array.from(wrapper.children);
  originalSlides.forEach((slide, i) => (slide.dataset.originalIndex = i));

  const mq = window.matchMedia('(max-width: 575px)');
  let primaryVideo = null;
  let keepAlive = null;
  let swiperHooked = false;

  function getSwiper() {
    const el = section.querySelector('.swiper');
    return el && el.swiper ? el.swiper : null;
  }
  function updateSwiper() {
    const sw = getSwiper();
    if (sw) { sw.updateSlides(); sw.update(); }
  }

  // Restore original order (desktop)
  function restoreDesktopOrder() {
    const ordered = Array.from(wrapper.children)
      .sort((a,b) => (+a.dataset.originalIndex) - (+b.dataset.originalIndex));
    ordered.forEach(n => wrapper.appendChild(n));
    updateSwiper();
  }

  // Mobile: move ONLY the first real slide with a video to the front
  function moveFirstVideoToFrontMobile() {
    const realSlides = Array.from(wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)'));
    const firstVideoSlide = realSlides.find(s => s.querySelector('video.carousel-new-2__video'));
    if (!firstVideoSlide) return;
    if (wrapper.firstElementChild !== firstVideoSlide) {
      wrapper.insertBefore(firstVideoSlide, wrapper.firstElementChild);
      updateSwiper();
    }
  }

  // Pick the primary (only) mobile video from the real slides
  function pickPrimaryMobileVideo() {
    const realSlides = Array.from(wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)'));
    const slide = realSlides.find(s => s.querySelector('video.carousel-new-2__video'));
    return slide ? slide.querySelector('video.carousel-new-2__video') : null;
  }

  // Ensure attributes & layering for autoplay on mobile
  function ensureAttrs(v) {
    v.muted = true; v.setAttribute('muted','');
    v.playsInline = true; v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
    v.loop = true; v.setAttribute('loop','');
    v.autoplay = true; v.setAttribute('autoplay','');
    v.preload = 'auto';
    v.style.setProperty('display', 'block', 'important');
    v.style.opacity = '1';
    v.removeAttribute('poster'); // avoid poster sticking
    // erase any handlers that might pause
    v.onpause = null; v.onended = null;
    // reassert layering now
    forceLayer(v);
  }

  // z-index layering enforcement
  function forceLayer(videoEl) {
    if (!videoEl) return;
    const box = videoEl.closest('.product-card__image');
    if (box) box.style.setProperty('position', 'relative', 'important');
    videoEl.style.setProperty('position', 'absolute', 'important');
    videoEl.style.setProperty('inset', '0', 'important');
    videoEl.style.setProperty('z-index', '10', 'important');
    videoEl.style.setProperty('display', 'block', 'important');
    videoEl.style.setProperty('opacity', '1', 'important');
    videoEl.style.setProperty('object-fit', 'cover', 'important');
    const img = box ? (box.querySelector('img.img-fill.hide-mobile') || box.querySelector('img.img-fill') || box.querySelector('img')) : null;
    if (img) {
      img.style.setProperty('position', 'absolute', 'important');
      img.style.setProperty('inset', '0', 'important');
      img.style.setProperty('z-index', '1', 'important');
      img.style.setProperty('object-fit', 'cover', 'important');
    }
  }
  function reassertZIndex() {
    if (!mq.matches) return;
    const v = pickPrimaryMobileVideo();
    if (v) forceLayer(v);
  }

  // keep playing helpers
  function forcePlay(v) {
    if (!v) return;
    try { if (v.ended) v.currentTime = 0; } catch(_) {}
    const p = v.play && v.play();
    if (p && p.catch) {
      setTimeout(() => { v.play && v.play().catch(()=>{}); }, 150);
      setTimeout(() => { v.play && v.play().catch(()=>{}); }, 400);
    }
  }

  function startMobile() {
    moveFirstVideoToFrontMobile();

    // (re)pick the primary video from real slides
    const next = pickPrimaryMobileVideo();
    if (!next) return;

    if (primaryVideo !== next) {
      primaryVideo = next;
      ensureAttrs(primaryVideo);

      const resume = () => { if (mq.matches) forcePlay(primaryVideo); };
      ['pause','ended','stalled','suspend','waiting','emptied','abort','error'].forEach(ev => {
        primaryVideo.addEventListener(ev, resume);
      });

      if (primaryVideo.readyState >= 1) forcePlay(primaryVideo);
      else primaryVideo.addEventListener('loadedmetadata', () => forcePlay(primaryVideo), { once: true });
    } else {
      ensureAttrs(primaryVideo);
      forcePlay(primaryVideo);
    }

    reassertZIndex();

    // keep-alive to defeat any swiper-induced pauses
    if (keepAlive) clearInterval(keepAlive);
    keepAlive = setInterval(() => {
      if (!mq.matches) return;
      if (!primaryVideo || !primaryVideo.isConnected) {
        primaryVideo = pickPrimaryMobileVideo();
        if (primaryVideo) { ensureAttrs(primaryVideo); forcePlay(primaryVideo); reassertZIndex(); }
        return;
      }
      if (primaryVideo.paused) { ensureAttrs(primaryVideo); forcePlay(primaryVideo); }
    }, 800);

    // Hook into swiper to re-assert after swipes/updates
    const sw = getSwiper();
    if (sw && sw.on && !swiperHooked) {
      const refresh = () => setTimeout(() => { startMobile(); reassertZIndex(); }, 20);
      ['init','slideChange','transitionEnd','update','resize','setTranslate','setTransition','reachBeginning','reachEnd']
        .forEach(ev => sw.on(ev, refresh));
      swiperHooked = true;
    }
  }

  function stopMobile() {
    if (keepAlive) { clearInterval(keepAlive); keepAlive = null; }
    if (primaryVideo) { try { primaryVideo.pause(); } catch(_) {} }
    primaryVideo = null;
  }

  function apply() {
    if (mq.matches) {
      startMobile();
    } else {
      stopMobile();
      restoreDesktopOrder();
      // ensure nothing plays on desktop
      section.querySelectorAll('video.carousel-new-2__video').forEach(v => { try { v.pause(); } catch(_) {} });
    }
  }

  // MutationObserver to catch DOM changes (e.g., swiper clones/updates)
  const mo = new MutationObserver(() => { if (mq.matches) { startMobile(); reassertZIndex(); } });
  mo.observe(wrapper, { childList: true, subtree: false, attributes: true, attributeFilter: ['class','style'] });

  // Visibility + first touch to help strict autoplay environments
  document.addEventListener('visibilitychange', () => { if (!document.hidden && mq.matches) startMobile(); });
  section.addEventListener('touchstart', () => { if (mq.matches && primaryVideo) forcePlay(primaryVideo); }, { passive: true });

  // Initial apply + breakpoint listener
  apply();
  if (mq.addEventListener) mq.addEventListener('change', apply);
  else mq.addListener(apply);
})();
</script>

{% schema %}
{
  "name": "Product Carousel New 2",
  "tag": "section",
  "class": "product-carousel with-spacing",
  "settings": [
    { "type": "textarea", "id": "heading", "label": "Heading" },
    { "type": "color", "id": "background", "label": "Background" },
    { "type": "checkbox", "id": "show_metafield_style", "label": "Show metafield style", "default": false },
    { "type": "collection", "id": "collection", "label": "Collection" },
    {
      "type": "select",
      "id": "product_card_type",
      "label": "Product Card Type",
      "options": [
        { "label": "Standard Card", "value": "standard_card" },
        { "label": "Video Card (metafield)", "value": "video_card" }
      ],
      "default": "standard_card"
    },
    { "type": "text", "id": "button_text", "label": "Button text", "default": "Shop Now" },
    { "type": "url", "id": "btn_link", "label": "Bottom Button Link" }
  ],
  "presets": [ { "name": "Product Carousel New 2" } ]
}
{% endschema %}