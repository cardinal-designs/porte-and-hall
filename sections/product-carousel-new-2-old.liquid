{{ 'component-product-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'section-product-carousel.css' | asset_url | stylesheet_tag }}

{% style %}
  .product-card .product-card__metafield-style {
    background: #546b82;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 24px;
    text-transform: uppercase;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 27%;
  }

  .product-carousel .swiper-button-next {
    right: 0;
  }

 .product-card__price.body.blue {
    margin-top: -12px;
  }

  
  .product-carousel__container-new-2 .product-card__swatches {
    margin: 0;
  }

  @media screen and (max-width: 768px) {
    .product-carousel__container-new-2 {
      margin-left: 0;
      margin-right: 0;
      width: 100% !important;
    }
  }
  
  @media screen and (max-width: 575px) {
    .product-carousel .swiper-button-next {
      right: 18px;
    }

    .product-card__image {
      aspect-ratio: 0.9;
    }

    .product-card {
      gap: 5px;
    }

    .product-card__price.body.blue {
      margin-top: -5px;
      font-size: 13px;
      letter-spacing: .3px;
    }

    .product-card__title {
      font-size: 13px;
      letter-spacing: 0;
    }

     .product-card__title span {
      font-size: 13px;
      letter-spacing: 0;
    }

    .product-carousel__container-new-2 {
      height: 300px !important;
    }
  
    .product-carousel__container-new-2 .swiper-pagination {
      bottom: 20px !important;
    }

    .carousel-new-2__video {
      object-fit: cover;
      height: 100%;
    }
  }
  
 @media screen and (max-width: 500px) {
  .product-carousel .swiper-button-next, .product-carousel .swiper-button-prev {
    top: 19%;
  }
 }
{% endstyle %}

<div class="product-carousel__inner product-carousel__new">
  <div class="product-carousel__heading">
    <h2 class="blue">{{ section.settings.heading }}</h2>
  </div>

  <product-carousel-new-two>
    <div class="product-carousel__container-new product-carousel__container-new-2 product-carousel__container swiper">
      <div class="swiper-wrapper">
        {% for product in section.settings.collection.products limit: 4 %}
          {% for collection in product.collections %}
            {% if collection.title contains ' |' %}
              {% assign grouped_collection = collection %}
            {% endif %}
          {% endfor %}
          {% assign only_one = false %}
          {% if product.handle contains 'wild-side' %}
            {% assign only_one = true %}
          {% endif %}
          <div class="product-carousel__item swiper-slide">
            {% if section.settings.product_card_type == 'standard_card' %}
            {% render 'grouped-product-card-2',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text
            %}
          {% else %}
            {% render 'grouped-product-card-3',
              product_card_product: product,
              collection: grouped_collection,
              title: grouped_collection.title,
              button_text: section.settings.button_text,
              only_show_one: only_one
            %}
          {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="swiper-pagination product-carousel__pagination"></div>
    </div>
    {% if section.settings.btn_link != blank %}
    <a class="shop-all-btn" href="{{ section.settings.btn_link }}">SHOP ALL BEST SELLERS</a>
    {% endif %}
  </product-carousel-new-two>
</div>

<style>
  {% if section.settings.background != blank %}
    #shopify-section-{{section.id }}.product-carousel {
      background: {{ section.settings.background }};
    }
  {% endif %}
</style>

<script>
(function () {
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section) return;

  const wrapper = section.querySelector('.swiper-wrapper');
  if (!wrapper) return;

  // Capture original order once
  const originalSlides = Array.from(wrapper.children);
  originalSlides.forEach((slide, i) => (slide.dataset.originalIndex = i));

  function restoreDesktopOrder() {
    const ordered = Array.from(wrapper.children).sort(
      (a, b) => +a.dataset.originalIndex - +b.dataset.originalIndex
    );
    ordered.forEach(node => wrapper.appendChild(node));
    const swiper = section.querySelector('.swiper')?.swiper;
    if (swiper) { swiper.updateSlides(); swiper.update(); }
  }

  function moveVideosToFront() {
    // ORIGINAL BEHAVIOR: move ALL slides that contain a video to the front
    const slides = Array.from(wrapper.children);
    const withVideo = slides.filter(slide =>
      slide.querySelector('video.carousel-new-2__video')
    );
    const withoutVideo = slides.filter(
      slide => !slide.querySelector('video.carousel-new-2__video')
    );
    [...withVideo, ...withoutVideo].forEach(node => wrapper.appendChild(node));
    const swiper = section.querySelector('.swiper')?.swiper;
    if (swiper) { swiper.updateSlides(); swiper.update(); }
  }

  // Watch for mobile/desktop breakpoint
  const mq = window.matchMedia('(max-width: 575px)');
  let currentLayoutIsMobile = null;

  function applyLayout(isMobile) {
    if (currentLayoutIsMobile === isMobile) return;
    currentLayoutIsMobile = isMobile;
    if (isMobile) {
      moveVideosToFront();
      // Rebuild the sequence and start mobile playback (fixed)
      prepareAllVideos();
      startMobileSequencer();
    } else {
      restoreDesktopOrder();
      // Desktop: no playback
      pauseAllToImages();
    }
  }

  // Initial + listener
  applyLayout(mq.matches);
  if (mq.addEventListener) mq.addEventListener('change', e => applyLayout(e.matches));
  else mq.addListener(e => applyLayout(e.matches));

  // ==============================
  // VIDEO LOGIC (ORIGINAL, with fixes)
  // ==============================

  let videos = [];
  let seq = [];
  let idx = 0;

  // IMPORTANT FIX: only use real slides (avoid Swiper duplicates)
  function collectRealVideos() {
    // Find videos inside slides that are NOT .swiper-slide-duplicate
    const realSlides = Array.from(wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)'));
    const found = [];
    realSlides.forEach(slide => {
      const v = slide.querySelector('video.carousel-new-2__video');
      if (v) found.push(v);
    });
    return found;
  }

  function getCard(videoEl) {
    return videoEl.closest('.product-card__image') || videoEl.parentElement;
  }

  function getImg(videoEl) {
    const box = getCard(videoEl);
    if (!box) return null;
    let img = box.querySelector('img.img-fill.hide-mobile');
    if (!img) img = box.querySelector('img.img-fill');
    if (!img) img = box.querySelector('img');
    return img;
  }

  function prepLayering(videoEl, imgEl) {
    const box = getCard(videoEl);
    if (box && getComputedStyle(box).position === 'static') {
      box.style.position = 'relative';
    }
    Object.assign(videoEl.style, {
      position: 'absolute',
      inset: '0',
      width: '100%',
      height: '100%',
      objectFit: 'cover',
      zIndex: '2',
      transition: 'opacity 200ms ease'
    });
    if (imgEl) {
      Object.assign(imgEl.style, {
        position: 'absolute',
        inset: '0',
        width: '100%',
        height: '100%',
        objectFit: 'cover',
        zIndex: '1',
        transition: 'opacity 200ms ease'
      });
    }
  }

  function showImage(img) {
    if (!img) return;
    img.style.setProperty('display', 'block', 'important');
    img.style.opacity = '1';
    img.removeAttribute('aria-hidden');
  }

  function hideImage(img) {
    if (!img) return;
    img.style.opacity = '0';
    setTimeout(() => {
      img.style.setProperty('display', 'none', 'important');
      img.setAttribute('aria-hidden', 'true');
    }, 200);
  }

  function showVideo(v) { v.style.opacity = '1'; }
  function hideVideo(v) { v.style.opacity = '0'; }

  function pauseAndShowImage(v) {
    try { v.pause(); } catch (_) {}
    hideVideo(v);
    const img = getImg(v);
    showImage(img);
  }

  function prepareAllVideos() {
    videos = collectRealVideos();
    videos.forEach(v => {
      const img = getImg(v);
      prepLayering(v, img);

      // Keep original mobile sequencing behavior â†’ rely on 'ended'
      v.removeAttribute('loop');
      v.muted = true;
      v.autoplay = false;
      v.playsInline = true;
      v.preload = v.preload || 'metadata';

      showImage(img);
      hideVideo(v);

      v.onplay = null; v.onpause = null;
      v.addEventListener('play', () => {
        // one-at-a-time: pause others
        videos.forEach(o => { if (o !== v) pauseAndShowImage(o); });
        hideImage(getImg(v));
        showVideo(v);
      });

      v.addEventListener('pause', () => {
        if (!v.ended) {
          hideVideo(v);
          showImage(getImg(v));
        }
      });
    });
    // IMPORTANT FIX: build sequence from real videos (no visibility filtering)
    seq = videos.slice();
    if (idx >= seq.length) idx = 0;
  }

  function playAt(i) {
    if (!mq.matches) return; // guard: mobile only
    if (!seq.length) return;

    idx = (i + seq.length) % seq.length;
    const current = seq[idx];

    // Pause others
    videos.forEach(v => { if (v !== current) pauseAndShowImage(v); });

    // Show and play current
    hideImage(getImg(current));
    showVideo(current);
    try { if (current.ended || current.currentTime > 0) current.currentTime = 0; } catch (_) {}

    const p = current.play && current.play();
    if (p && p.catch) p.catch(() => { /* ignore autoplay rejection */ });

    // Advance when it ends (original behavior)
    seq.forEach(v => v.removeEventListener('ended', handleEnded));
    current.addEventListener('ended', handleEnded, { once: true });
  }

  function handleEnded() {
    const justEnded = seq[idx];
    if (justEnded) {
      hideVideo(justEnded);
      showImage(getImg(justEnded));
    }
    playAt(idx + 1);
  }

  function startMobileSequencer() {
    prepareAllVideos();
    if (!seq.length) return;

    // Wait for metadata so durations are known
    if (videos.some(v => v.readyState < 1)) {
      let left = videos.length, started = false;
      const done = () => { if (!started && --left <= 0) { started = true; playAt(0); } };
      videos.forEach(v => {
        if (v.readyState >= 1) done();
        else { v.addEventListener('loadedmetadata', done, { once: true }); setTimeout(done, 1200); }
      });
    } else {
      playAt(0);
    }
  }

  // Desktop: keep everything paused with image shown
  function pauseAllToImages() {
    (videos.length ? videos : collectRealVideos()).forEach(pauseAndShowImage);
  }

  // === Swiper hook to keep mobile video alive after any slide change ===
  (function hookSwiper() {
    const getSwiper = () => section.querySelector('.swiper')?.swiper || null;
    const refresh = () => {
      if (!mq.matches) return;          // only care on mobile
      // Re-collect real videos in case Swiper changed DOM,
      // keep current index, and if the current one got paused, play it again.
      const current = seq[idx];
      prepareAllVideos();
      // Try to locate the same element if it still exists, else keep idx as-is
      let resumeTarget = current && videos.find(v => v === current) ? current : seq[idx];
      if (resumeTarget && resumeTarget.paused) {
        // ensure it's visible (image hidden) and playing
        hideImage(getImg(resumeTarget));
        showVideo(resumeTarget);
        const p = resumeTarget.play && resumeTarget.play();
        if (p && p.catch) p.catch(() => {});
      }
    };

    const sw = getSwiper();
    if (sw && sw.on) {
      ['init','slideChange','slideChangeTransitionStart','slideChangeTransitionEnd','transitionEnd','update','resize','reachBeginning','reachEnd']
        .forEach(ev => sw.on(ev, () => setTimeout(refresh, 20)));
    } else {
      // If Swiper attaches later
      const obs = new MutationObserver(() => {
        const s = getSwiper();
        if (s && s.on) {
          ['init','slideChange','slideChangeTransitionStart','slideChangeTransitionEnd','transitionEnd','update','resize','reachBeginning','reachEnd']
            .forEach(ev => s.on(ev, () => setTimeout(refresh, 20)));
          obs.disconnect();
        }
      });
      obs.observe(section, { childList: true, subtree: true });
    }
  })();

  // Also resume when tab regains focus (mobile browsers often pause video)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && mq.matches && seq.length) {
      const current = seq[idx];
      if (current && current.paused) {
        hideImage(getImg(current));
        showVideo(current);
        const p = current.play && current.play();
        if (p && p.catch) p.catch(() => {});
      }
    }
  });

  // Kick once on initial load for current breakpoint
  if (mq.matches) {
    prepareAllVideos();
    startMobileSequencer();
  }
})();
</script>

{% schema %}
{
  "name": "ProductCarouselNew2 (old)",
  "tag": "section",
  "class": "product-carousel with-spacing",
  "settings": [
    {
      "type": "textarea",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_metafield_style",
      "label": "Show metafield style",
      "default": false
    },    
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "product_card_type",
      "label": "Product Card Type",
      "options": [
        {
          "label": "Standard Card",
          "value": "standard_card"
        },
        {
          "label": "Video Card (metafield)",
          "value": "video_card"
        }
      ],
      "default": "standard_card"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "btn_link",
      "label": "Bottom Button Link"
    }
  ],
  "presets": [
    {
      "name": "ProductCarouselNew2 (old)"
    }
  ]
}
{% endschema %}
