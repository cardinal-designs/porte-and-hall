{{ 'section-see-it-in-action.css' | asset_url | stylesheet_tag }}
{% liquid
  for collection in product.collections
    if collection.title contains ' | '
      assign grouped_collection = collection
    endif
  endfor

  assign style_categories = shop.metaobjects.style_category.values | sort: 'order'
  assign has_image = ""
 
  for category in style_categories 
   assign photos = category.product_photos.value 
   for photo in photos 
     assign match = photo.product_collection.value | where: 'id', grouped_collection.id 
     if match != blank 
      if has_image == ''
        assign has_image = category.name
      else
        assign has_image = has_image | append: ',' | append: category.name
      endif
     endif 
   endfor 
 endfor 

 assign has_image = has_image | split: ','
%}

{% unless has_image == '' %}
  <div class="page-width">
    <div class="see-it-in-action__inner">
      <div class="see-it-in-action__header">
        <h2 class="see-it-in-action__heading blue">{{ section.settings.heading | default: 'See it in action' }}</h2>

        {% if section.settings.link != blank and section.settings.link_text != blank %}
          <a href="{{ section.settings.link }}" class="text-link gold-secondary--dark see-it-in-action__link">
            {{- section.settings.link_text -}}
          </a>
        {% endif %}
      </div>

      <div class="see-it-in-action__tabs-wrapper">
        <div class="see-it-in-action__tabs-buttons">
          {% for style in style_categories %}
            {% unless has_image contains style.name %}
              {% continue %}
            {% endunless %}
            <button
              class="body-xs body-bold-weight {% if forloop.first %} active{% endif %}"
              data-action-tabs="{{ forloop.index0 }}"
            >
              {{ style.name }}
            </button>
          {% endfor %}
        </div>

        <div class="see-it-in-action__tabs-content">
          <div class="see-it-in-action__tabs swiper">
            <div class="swiper-wrapper">
              {% for style in style_categories %}
                {% unless has_image contains style.name %}
                  {% continue %}
                {% endunless %}
                {% assign photos = style.product_photos.value %}
                {% for photo in photos %}
                  {% assign match = photo.product_collection.value | where: 'id', grouped_collection.id %}
                  {% if match != blank %}
                    <div class="swiper-slide">
                      <div class="see-it-in-action__tabs-item">
                        <div class="see-it-in-action__tabs-image">
                          {% assign photo_object = photo.image.value | file_url %}
                          {{ photo.image | image_url: width: 1200 | image_tag }}
                        </div>
    
                        <div class="see-it-in-action__tabs-label body-xs">{{ photo.product_name }} {{ photo.image.aspect_ratio }}</div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endunless %}

{% javascript %}
  const tabsButtons = document.querySelectorAll('[data-action-tabs]');

  const seeItSlider = new Swiper('.see-it-in-action__tabs', {
    slidesPerView: 1,
    spaceBetween: 0,
    allowTouchMove: false,
    loop: false,
    autoplay: {
      delay: 5000,
    },
    on: {
      slideChange: function () {
        Array.from(tabsButtons)
          .find((btn) => btn.classList.contains('active'))
          .classList.remove('active');
        Array.from(tabsButtons)
          .find((btn) => btn.dataset.actionTabs == this.activeIndex)
          .classList.add('active');
      },
    },
  });

  tabsButtons.forEach((button) => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      seeItSlider.slideTo(e.target.dataset.actionTabs);
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "See It In Action",
  "tag": "section",
  "class": "see-it-in-action with-spacing",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "heading"
    },
    {
      "type": "url",
      "id": "link",
      "label": "Link"
    },
    {
      "type": "text",
      "id": "link_text",
      "label": "Link text"
    }
  ]
}
{% endschema %}
